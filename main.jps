type: update
version: 0.1
name: Zabbix Agent
baseUrl: https://raw.githubusercontent.com/panslothda/Jelastic-Zabbix-Agent/master
logo: images/zabbix.svg
homepage: https://zabbix.com
description: |
  Zabbix Agent for monitoring of nodes and servers  
  This Addon installs the Agent and allows you to configure it.  
  **Only CENTOS nodes**
short: Zabbix Agent for monitoring of nodes and servers
skipNodeEmails: true

targetNodes:
  nodeGroup: '*'

settings:
  fields:
    - type: string
      name: serverip
      caption: Zabbix server IP
      placeholder: 10.0.0.1
      required: true
    - type: checkbox
      name: remotecmd
      value: false
      caption: Enable remote commands from Zabbix server
      showIf:
        true:
          type: checkbox
          name: remotelogging
          value: false
          caption: Enable logging of executed shell commands as warnings
        false:
          type: compositefield
          hideLabel: true
          pack: left
          name: remotelogging
          value: false
          itemCls: deploy-manager-grid
          cls: x-grid3-row-unselected
          items: [{
            type: "displayfield",
            cls: "x-grid3-row-checker x-item-disabled",
            margins: "0 0 0 -3",
            width: 20,
            height: 20
          }, {
            type: "displayfield",
            cls: "x-item-disabled",
            value: "Enable logging of executed shell commands as warnings",
            margins: "0 0 0 10"
          }]


onInstall:
  - variables-modification
  - download-install-zabbix
  - configure-zabbix-agent


buttons:
  - confirmText: Do you want to update the Zabbix Agent?
    loadingText: Updating...
    action: update
    caption: Update Zabbix Agent
    successText: Zabbix Agent has been upgraded
  - caption: Configure
    action: configure
    loadingText: Configuring...
    successText: /text/success.md


actions:
  variables-modification:
    - log: check variables and set them correctly
    - if (settings.remotecmd === true):
        setGlobals: 
          REMOTE_COMMAND: EnableRemoteCommands=1
    - else:
        setGlobals: 
          REMOTE_COMMAND: DenyKey=system.run[*]
    - if (settings.remotelogging === true):
        setGlobals: 
          REMOTE_LOGGING: 1
    - else:
        setGlobals: 
          REMOTE_LOGGING: 0
    - setGlobals:
        SERVER_IP: ${settings.serverip}

  download-install-zabbix:
    - log: Downloads and installs Zabbix Agent
    - cmd [${targetNodes.nodeGroup}]: |-
        rpm --import https://repo.zabbix.com/RPM-GPG-KEY-ZABBIX-A14FE591 &>> /var/log/run.log
        rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-agent-5.0.0-1.el7.x86_64.rpm &>> /var/log/run.log
        echo /etc/zabbix >> /etc/jelastic/redeploy.conf
      user: root
      sayYes: true

  configure-zabbix-agent:
    - log: Configures the Zabbix Agent with chosen details
    - cmd [${targetNodes.nodeGroup}]: |-
        SERVER=$(hostname)
        sed -i '171d' /etc/zabbix/zabbix_agentd.conf
        sed -i "171i Hostname=$SERVER" /etc/zabbix/zabbix_agentd.conf
        sed -i '119d' /etc/zabbix/zabbix_agentd.conf
        sed -i "119i Server=${globals.SERVER_IP}" /etc/zabbix/zabbix_agentd.conf
        sed -i '160d' /etc/zabbix/zabbix_agentd.conf
        sed -i "160i ServerActive=${globals.SERVER_IP}" /etc/zabbix/zabbix_agentd.conf
        sed -i '76d' /etc/zabbix/zabbix_agentd.conf
        sed -i "76i ${globals.REMOTE_COMMAND}" /etc/zabbix/zabbix_agentd.conf
        sed -i '103d' /etc/zabbix/zabbix_agentd.conf
        sed -i "103i LogRemoteCommands=${globals.REMOTE_LOGGING}" /etc/zabbix/zabbix_agentd.conf
        systemctl start zabbix-agent
        systemctl enable zabbix-agent
      user: root
      sayYes: true

  update:
    - log: Configure the zabbix Agent
    - install: ${baseUrl}/scripts/update-agent.jps
      settings:
        node: "${targetNodes.nodeGroup}"
      skipEmail: true

  configure:
    - log: Configure the zabbix Agent
    - install: ${baseUrl}/scripts/configure-agent.jps
      settings:
        node: "${targetNodes.nodeGroup}"
      skipEmail: true

success:
  text: text/success.md
